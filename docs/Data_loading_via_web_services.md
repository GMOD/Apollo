# Data Loading via Web Services

If you setup your Apollo instance on a remote server and your data is on your local machine, you can make use of Apollo 
Web Services API to load your locally processed (and raw) data into Apollo.

**Note:** Only the admin user can make use of Web Services for loading data into Apollo.


While setting up Apollo, make sure you set `common_data_directory` in your `apollo-config.groovy`:

```
common_data_directory = "/opt/apollo"
```

By default this is `/opt/apollo` which can be changed to any other location on the file system where you would want 
Apollo to store files uploaded via Web Services.



### Adding organism with sequence

You can add an organism along with its sequence data (generated by `prepare-refseqs.pl`) to Apollo.
This is useful when an organism's data is not on the same server as the Apollo instance.

For the sake of an easy example, we will demonstrate how to upload your organism sequence data to Apollo with 
Web Services using `curl`.

```
curl http://localhost:8080/apollo/organism/addOrganismWithSequence  \
    -F "commonName=Amel" \
    -F "username=admin" \
    -F "password=admin" \
    -F "organismData=@compressed-jbrowse-data.zip"
```

`curl` will upload your `compressed-jbrowse-data.zip` file to Apollo.

Once the upload is complete, Apollo will decompress the file and place it in `common_data_directory` (specified in your `apollo-config.groovy`).
Apollo will then create an organism with the supplied common name and link to the decompressed data folder as its directory. 

Currently the `organism/addOrganismWithSequence` endpoint supports Zip (\*.zip) and Tar GZip (\*.tar.gz) compressed folders.



### Adding tracks to an organism

You can add a track to an existing organism with the `organism/addTrackToOrganism` endpoint.

Here is an example that uploads a compressed folder containing track data (generated by `flatfile-to-json.pl`) to an 
existing organism.

```
curl http://localhost:8080/apollo/organism/addTrackToOrganism \
    -F "organism=100001" \
    -F "username=admin" \
    -F "password=admin" \
    -F "trackData=@/path/to/compressed-track-data.zip" \
    -F "trackConfig={'label': 'track_name',type: 'FeatureTrack', 'urlTemplate': 'tracks/track_name/\{refseq\}/trackData.json'}"

```

The track configuration (JBrowse JSON) must be supplied via `trackData` parameter and this JSON must contain 'label'
and 'urlTemplate'.  

**Note**: The label is a unique identifier used to reference the track and can not be changed, just removed.

Here is another example that uploads a BAM file along with its index to an existing organism.

```
curl http://localhost:8080/apollo/organism/addTrackToOrganism \
    -F "organism=100001" \
    -F "username=admin" \
    -F "password=admin" \
    -F "trackFile=@alignments.bam" \
    -F "trackFileIndex=@alignments.bam.bai" \
    -F "trackConfig={'label': 'bam_alignments', 'urlTemplate': 'bam/alignments.bam', 'key': 'BAM Alignments','type': 'JBrowse/View/Track/Alignments2'}"
```

`trackFile` parameter takes in the BAM file (or any other flat file like *.vcf, *.vcf.gz, *.bw, *.bigwig, etc.)

`trackFileIndex` parameter takes in the index for the file provided by `trackFile`, and this parameter is optional since 
not all flat files will have its associated index.

You can use this endpoint to add a track to any organism, irrespective of whether it was added by `organism/addOrganismWithSequence` endpoint.

In both cases, Apollo will take the uploaded data and store it in `common_data_directory`. 


### Updating a track for an organism

You can update an existing track from an organism via the `organism/updateTrackForOrganism` endpoint.

As an example, lets update the previously added track with some additional configurations.

```
curl http://localhost:8080/apollo/organism/updateTrackForOrganism \
    -F "organism=100001" \
    -F "username=admin" \
    -F "password=admin" \
    -F "trackConfig={'label': 'track_name', 'urlTemplate': 'tracks/track_name/\{refseq\}/trackData.json', 'key': 'Track Name', 'type': 'JBrowse/View/Track/CanvasFeatures'}"    

```

This endpoint will overwrite an existing track's configuration in favor for the configuration provided by the `trackConfig` parameter.
Thus, provide the entire track's JSON configuration with all relevant parameters.


**Note:** This operation will be successful only for tracks added by `organism/addTrackToOrganism` endpoint.



### Deleting a track from an organism

You can delete a track from an organism using the `organism/deleteTrackFromOrganism` endpoint.

As an example, lets remove the previously added BAM track.

```
curl  http://localhost:8080/apollo/organism/deleteTrackFromOrganism \
    -F "organism=100001"  \
    -F "username=admin"  \
    -F "password=admin"  \
    -F "trackLabel=bam_alignments" 

```

`trackLabel` corresponds to the `label` parameter in a track's JSON configuration and will be used to uniquely identify a track.


**Note:** This operation will be successful only for tracks added by `organism/addTrackToOrganism` endpoint.



### Delete an organism along with its data

You can delete an organism along with its data directory using the `organism/deleteOrganismWithSequence` endpoint.

Few things to bear in mind before sending a request to this endpoint:
* This operation will delete both the organism and its data directory only for those organisms added via 
`organism/addOrganismWithSequence` endpoint.
* If you try this on an organism that was not added by `organism/addOrganismWithSequence` endpoint, Apollo will still 
delete the organism but will only remove the data that the organism has in the `common_data_directory` (if any) while 
leaving the original organism data directory and its contents intact. Apollo will also return a warning stating that it 
cannot remove the organism's data directory.

As an example, lets remove the organism Amel with ID `100001`:

```
curl http://localhost:8080/apollo/organism/deleteOrganismWithSequence  \
    -F "organism=100001" \
    -F "username=admin" \
    -F "password=admin" \

```

This will remove organism with ID `100001`. 
Since this organism was added by the `organism/addOrganismWithSequence` endpoint, Apollo will delete its data directory 
from `common_data_directory`. 

